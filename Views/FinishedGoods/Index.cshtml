@{
    ViewData["Title"] = "√úretim Fi≈üleri";
}

<div class="container mt-4">
    <h2 class="mb-4">üè≠ √úretim Fi≈üleri (Finished Goods)</h2>

    <div class="mb-3">
        <button id="btnYeni" class="btn btn-success fw-bold">‚ûï Yeni Fi≈ü</button>
        <button id="btnYenile" class="btn btn-primary fw-bold ms-2">üîÑ Yenile</button>
    </div>

    <!-- üîî Bildirim alanƒ± -->
    <div id="alertArea"></div>

    <table id="finishedTable" class="table table-bordered table-hover align-middle" data-editable="true">
        <thead class="table-light">
            <tr>
                <th>Fi≈ü No</th>
                <th>Tarih</th>
                <th>Depo</th>
                <th>Malzeme</th>
                <th>Miktar</th>
                <th>Birim</th>
                <th>ƒ∞≈ülem</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="7" class="text-center text-muted">Y√ºkleniyor...</td></tr>
        </tbody>
    </table>
</div>

<!-- üîß Yeni Fi≈ü Modal -->
<div class="modal fade" id="newModal" tabindex="-1" aria-labelledby="newModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border-success shadow">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold" id="newModalLabel">‚ûï Yeni √úretim Fi≈üi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createFinishedForm">
                    <div class="mb-2">
                        <label class="form-label small">Fi≈ü No <span class="text-danger">*</span></label>
                        <input name="FisNo" class="form-control" placeholder="√ñrn: FIS001" required />
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Tarih <span class="text-danger">*</span></label>
                        <input name="Tarih" type="date" class="form-control" required />
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Depo Kodu <span class="text-danger">*</span></label>
                        <input name="Depo" class="form-control" placeholder="√ñrn: 001" required />
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Malzeme Kodu <span class="text-danger">*</span></label>
                        <input name="Malzeme" class="form-control" placeholder="√ñrn: MAL001" required />
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Miktar <span class="text-danger">*</span></label>
                        <input name="Miktar" type="number" step="0.001" class="form-control" placeholder="0.000" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label small">Birim <span class="text-danger">*</span></label>
                        <input name="Birim" class="form-control" placeholder="√ñrn: Adet, KG" required />
                    </div>
                    <button type="submit" class="btn btn-success w-100 fw-bold">üíæ Kaydet</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- üîç Detay Modal -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-warning shadow">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title fw-bold" id="detailModalLabel">üìã √úretim Fi≈üi Detayƒ±</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="detailInfo" class="mb-3 border rounded p-2 bg-light small"></div>
                <table class="table table-bordered table-striped align-middle">
                    <thead class="table-warning">
                        <tr>
                            <th>#</th>
                            <th>Stok Kodu</th>
                            <th>Depo Kodu</th>
                            <th>Miktar</th>
                            <th>BG Tip</th>
                            <th>Seri Var mƒ±</th>
                            <th>A√ßƒ±klama</th>
                        </tr>
                    </thead>
                    <tbody id="detailTableBody" data-editable="true">
                        <tr><td colspan="7" class="text-center text-muted">Y√ºkleniyor...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const tbody = document.querySelector("#finishedTable tbody");
            const alertArea = document.getElementById("alertArea");

            // üîî Bildirim g√∂ster
            function showAlert(message, type = "success") {
                const alertDiv = document.createElement("div");
                alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                alertArea.appendChild(alertDiv);
                setTimeout(() => alertDiv.remove(), 5000);
            }

            // ‚úÖ Listele
            async function loadList() {
                tbody.innerHTML = "<tr><td colspan='7' class='text-center text-muted'>Y√ºkleniyor...</td></tr>";
                try {
                    const res = await fetch("/FinishedGoods/GetAll");
                    if (!res.ok) throw new Error("GET isteƒüi ba≈üarƒ±sƒ±z!");
                    
                    const json = await res.json();
                    console.log("üì¶ API Yanƒ±tƒ±:", json);

                    // ‚úÖ ApiResponse formatƒ±ndan data'yƒ± √ßek
                    const data = json.data || [];

                    tbody.innerHTML = "";
                    if (data.length === 0) {
                        tbody.innerHTML = "<tr><td colspan='7' class='text-center text-muted'>Kayƒ±t bulunamadƒ±.</td></tr>";
                        return;
                    }

                    data.forEach(x => {
                        tbody.innerHTML += `
                            <tr data-id="${x.fisNo}">
                                <td>${x.fisNo}</td>
                                <td class="fg-tarih">${x.tarih}</td>
                                <td class="fg-depo">${x.depo}</td>
                                <td class="fg-malzeme">${x.malzeme}</td>
                                <td class="fg-miktar">${x.miktar}</td>
                                <td class="fg-birim">${x.birim}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-warning edit" title="Detay">üîç</button>
                                    <button class="btn btn-sm btn-outline-danger delete" title="Sil">üóëÔ∏è</button>
                                </td>
                            </tr>`;
                    });
                } catch (err) {
                    console.error("‚ùå Listeleme hatasƒ±:", err);
                    tbody.innerHTML = "<tr><td colspan='7' class='text-center text-danger'>Listeleme hatasƒ±!</td></tr>";
                    showAlert(`‚ùå Hata: ${err.message}`, "danger");
                }
            }

            await loadList();

            // üîÑ Yenile butonu
            document.querySelector("#btnYenile").addEventListener("click", async () => {
                await loadList();
                showAlert("‚úÖ Liste yenilendi", "info");
            });

            // ‚ûï Yeni fi≈ü butonu
            document.querySelector("#btnYeni").addEventListener("click", () => {
                document.getElementById("createFinishedForm").reset();
                // Bug√ºn√ºn tarihini otomatik doldur
                const today = new Date().toISOString().split('T')[0];
                document.querySelector("input[name='Tarih']").value = today;
                new bootstrap.Modal("#newModal").show();
            });

            // üßæ Yeni fi≈ü kaydet
            document.querySelector("#createFinishedForm").addEventListener("submit", async e => {
                e.preventDefault();
                const form = e.target;
                const dto = {
                    FisNo: form.querySelector("input[name='FisNo']").value.trim(),
                    Tarih: form.querySelector("input[name='Tarih']").value,
                    Depo: form.querySelector("input[name='Depo']").value.trim(),
                    Malzeme: form.querySelector("input[name='Malzeme']").value.trim(),
                    Miktar: parseFloat(form.querySelector("input[name='Miktar']").value),
                    Birim: form.querySelector("input[name='Birim']").value.trim()
                };

                try {
                    const res = await fetch("/FinishedGoods/Create", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(dto)
                    });

                    const result = await res.json();

                    if (result.success) {
                        bootstrap.Modal.getInstance(document.getElementById("newModal")).hide();
                        showAlert(result.message || "‚úÖ Fi≈ü ba≈üarƒ±yla olu≈üturuldu!", "success");
                        await loadList();
                    } else {
                        const errors = result.errors?.join(", ") || result.message;
                        showAlert(`‚ùå ${errors}`, "danger");
                    }
                } catch (err) {
                    showAlert(`‚ùå Hata: ${err.message}`, "danger");
                }
            });

            // üóëÔ∏è Sil
            document.addEventListener("click", async e => {
                if (e.target.classList.contains("delete")) {
                    const id = e.target.closest("tr").dataset.id;
                    if (!confirm(`${id} numaralƒ± fi≈üi silmek istediƒüinize emin misiniz?`)) return;

                    try {
                        const res = await fetch(`/FinishedGoods/Delete/${id}`, { 
                            method: "DELETE" 
                        });

                        const result = await res.json();

                        if (result.success) {
                            showAlert(result.message || "‚úÖ Fi≈ü silindi", "success");
                            await loadList();
                        } else {
                            showAlert(`‚ùå ${result.message}`, "danger");
                        }
                    } catch (err) {
                        showAlert(`‚ùå Hata: ${err.message}`, "danger");
                    }
                }
            });

            // ‚úèÔ∏è Inline edit (√ßift tƒ±klama)
            document.addEventListener("dblclick", async e => {
                const td = e.target.closest("td");
                if (!td || td.querySelector("input") || td.classList.contains("no-edit")) return;
                
                const row = td.closest("tr");
                const id = row.dataset.id;
                const original = td.textContent.trim();
                const field = td.className.replace("fg-", "");
                
                if (!["tarih", "depo", "malzeme", "miktar", "birim"].includes(field)) return;

                const input = document.createElement("input");
                input.value = original;
                input.className = "form-control form-control-sm";
                if (field === "miktar") {
                    input.type = "number";
                    input.step = "0.001";
                }
                td.innerHTML = "";
                td.appendChild(input);
                input.focus();

                input.addEventListener("blur", async () => {
                    const newValue = input.value.trim();
                    
                    try {
                        const dto = { FisNo: id, Field: field, Value: newValue };
                        const res = await fetch("/FinishedGoods/UpdateInline", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(dto)
                        });

                        const result = await res.json();

                        if (result.success) {
                            td.textContent = newValue;
                            td.style.backgroundColor = "#d4edda";
                            setTimeout(() => (td.style.backgroundColor = ""), 1000);
                        } else {
                            td.textContent = original;
                            showAlert(`‚ùå ${result.message}`, "danger");
                        }
                    } catch (err) {
                        td.textContent = original;
                        showAlert(`‚ùå Hata: ${err.message}`, "danger");
                    }
                });

                input.addEventListener("keydown", e => {
                    if (e.key === "Escape") {
                        td.textContent = original;
                    } else if (e.key === "Enter") {
                        input.blur();
                    }
                });
            });

            // üîç Detay Modalƒ± (üîç butonuna tƒ±klama)
            document.addEventListener("click", async e => {
                if (e.target.classList.contains("edit")) {
                    const id = e.target.closest("tr").dataset.id;
                    const modal = new bootstrap.Modal("#detailModal");
                    modal.show();

                    const detailBody = document.getElementById("detailTableBody");
                    const detailInfo = document.getElementById("detailInfo");
                    detailBody.innerHTML = "<tr><td colspan='7' class='text-center text-muted'>Y√ºkleniyor...</td></tr>";
                    detailInfo.innerHTML = "";

                    try {
                        const res = await fetch(`/FinishedGoods/Detail/${id}`);
                        const json = await res.json();
                        
                        if (!json.success) {
                            detailBody.innerHTML = `<tr><td colspan='7' class='text-center text-danger'>${json.message}</td></tr>`;
                            return;
                        }

                        const data = json.data;

                        // üßæ √úst bilgi
                        detailInfo.innerHTML = `
                            <strong>Fi≈ü No:</strong> ${data.uretSon_FisNo} |
                            <strong>Tarih:</strong> ${data.uretSon_Tarih} |
                            <strong>Mamul:</strong> ${data.uretSon_Mamul} |
                            <strong>Miktar:</strong> ${data.uretSon_Miktar} |
                            <strong>Depo:</strong> ${data.uretSon_Depo}
                        `;

                        // üß© Kalem tablosu
                        const kalemler = data.kalem || [];
                        if (kalemler.length === 0) {
                            detailBody.innerHTML = "<tr><td colspan='7' class='text-center text-muted'>Kalem bulunamadƒ±.</td></tr>";
                            return;
                        }

                        detailBody.innerHTML = "";
                        kalemler.forEach(k => {
                            detailBody.innerHTML += `
                                <tr>
                                    <td>${k.index}</td>
                                    <td>${k.stokKodu}</td>
                                    <td>${k.depoKodu}</td>
                                    <td>${k.miktar}</td>
                                    <td>${k.bGTIP}</td>
                                    <td>${k.seriVarMi ? "‚úÖ" : "‚ùå"}</td>
                                    <td>${k.aciklama || ""}</td>
                                </tr>
                            `;
                        });

                    } catch (err) {
                        console.error("‚ùå Detay y√ºkleme hatasƒ±:", err);
                        detailBody.innerHTML = "<tr><td colspan='7' class='text-center text-danger'>Detay y√ºklenemedi!</td></tr>";
                        showAlert(`‚ùå Hata: ${err.message}`, "danger");
                    }
                }
            });

            // ‚úèÔ∏è Detay tablosunda miktar h√ºcresini d√ºzenleme (dblclick)
            document.addEventListener("dblclick", async e => {
                const td = e.target.closest("td");
                const tr = td?.closest("tr");
                const tableBody = document.getElementById("detailTableBody");

                // Sadece detay tablosundaki miktar s√ºtunu (4. s√ºtun)
                if (!tableBody || !tableBody.contains(tr) || td.cellIndex !== 3) return;

                const originalValue = td.textContent.trim();
                td.innerHTML = `<input type="number" step="0.001" value="${originalValue}" class="form-control form-control-sm" />`;
                const input = td.querySelector("input");
                input.focus();

                input.addEventListener("blur", async () => {
                    const newValue = parseFloat(input.value) || 0;

                    // Satƒ±rdaki kalem bilgilerini yakala
                    const cells = tr.querySelectorAll("td");
                    const fisNo = document.querySelector("#detailInfo").textContent.match(/Fi≈ü No:\s*(\S+)/)?.[1] || "";

                    const dto = {
                        fisNo,
                        index: parseInt(cells[0].textContent.trim()),
                        stokKodu: cells[1].textContent.trim(),
                        depoKodu: parseInt(cells[2].textContent.trim()),
                        miktar: newValue,
                        bGTIP: cells[4].textContent.trim(),
                        seriVarMi: cells[5].textContent.includes("‚úÖ"),
                        aciklama: cells[6].textContent.trim()
                    };

                    console.log("üì§ G√ºncellenecek kalem:", dto);

                    try {
                        const res = await fetch("/FinishedGoods/UpdateQuantity", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(dto)
                        });

                        const result = await res.json();

                        if (result.success) {
                            td.textContent = newValue.toFixed(3);
                            td.style.backgroundColor = "#d4edda";
                            showAlert(result.message || "‚úÖ Miktar g√ºncellendi", "success");
                        } else {
                            td.textContent = originalValue;
                            td.style.backgroundColor = "#f8d7da";
                            showAlert(`‚ùå ${result.message}`, "danger");
                        }

                        setTimeout(() => (td.style.backgroundColor = ""), 1500);
                    } catch (err) {
                        console.error("‚ùå Sunucu hatasƒ±:", err);
                        td.textContent = originalValue;
                        td.style.backgroundColor = "#f8d7da";
                        showAlert(`‚ùå Hata: ${err.message}`, "danger");
                        setTimeout(() => (td.style.backgroundColor = ""), 1500);
                    }
                });

                input.addEventListener("keydown", e => {
                    if (e.key === "Escape") {
                        td.textContent = originalValue;
                    } else if (e.key === "Enter") {
                        input.blur();
                    }
                });
            });
        });
    </script>
}
